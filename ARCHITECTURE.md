# MBTI-LLM 系统架构设计

## 📊 整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         L3 记忆与安全层                                │
├─────────────────────────────────────────────────────────────────────┤
│  • 人设记忆 (对话历史一致性)                                              │
│  • 安全边界 (避免误导映射)                                              │
│  • 漂移监测 (风格偏离纠正)                                              │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                         L2 控制器层                                   │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐   │
│  │   Persona       │    │   候选生成器     │    │   风格重排器     │   │
│  │   Prompt        │    │   (并发)        │    │   (评分筛选)     │   │
│  │   Builder       │    │                │    │                │   │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                         L1 人格状态层                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐   │
│  │   MBTI 向量     │    │   情绪状态机     │    │   行为规则库     │   │
│  │   E/I S/N       │    │   Valence       │    │   语言风格      │   │
│  │   T/F J/P       │    │   Arousal       │    │   结构模板      │   │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                         L0 基座模型层                                 │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐   │
│  │   Ollama        │    │  deepseek-llm   │    │   API 接口      │   │
│  │   服务          │    │    :7b          │    │   调用          │   │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

## 🔄 数据流处理图

```
用户输入 → 人格选择 → 系统提示构建 → 并发候选生成 → 风格评分 → 最佳回答

┌──────────┐    ┌──────────┐    ┌──────────────┐    ┌────────────────┐
│ 用户问题  │ ── │ 人格类型  │ ── │ 提示词构建    │ ── │ 候选生成器      │
│ "如何..."│    │ ENTJ     │    │ 系统角色+规则 │    │ ThreadPool    │
└──────────┘    └──────────┘    └──────────────┘    └────────────────┘
                                                           │
                                                           ▼
┌──────────┐    ┌──────────┐    ┌──────────────┐    ┌────────────────┐
│ 最佳回答  │ ◄─ │ 重排选择  │ ◄─ │ 风格评分      │ ◄─ │ 多个候选回答    │
│ + 评分   │    │ Top-1    │    │ 匹配度计算    │    │ [回答1,2,3...] │
└──────────┘    └──────────┘    └──────────────┘    └────────────────┘
```

## 🧩 核心组件架构

### 1. 人格规则映射器 (PersonalityRules)

```
PersonalityProfile {
    mbti: "ENTJ"
    e_score: 0.8     # 外向性 [-1,1]
    s_score: 0.2     # 感觉性 [-1,1] 
    t_score: 0.9     # 思考性 [-1,1]
    j_score: 0.9     # 判断性 [-1,1]
    valence: 0.2     # 情绪愉悦度
    arousal: 0.7     # 情绪唤醒度
}
                ↓
规则映射 {
    sentence_patterns: {
        direct_calls: 0.8,
        short_paragraphs: true,
        logical_structure: 0.9
    },
    vocabulary: {
        power_words: ["战略", "执行", "效率"],
        avoid_words: ["可能", "也许"]
    },
    structure: {
        opening: "结论先行",
        closing: "行动建议"
    }
}
```

### 2. 风格评分器 (StyleScorer)

```
文本输入 → 多维度分析 → 加权评分

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ 句子结构分析     │    │ 词汇匹配度       │    │ 语调一致性       │
│ • 平均句长      │    │ • 偏好词使用     │    │ • 感叹号比例     │
│ • 直接号召句    │    │ • 限定词频率     │    │ • 限定词使用     │
│ 权重: 0.3      │    │ 权重: 0.25      │    │ 权重: 0.2       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                ↓
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ 长度风格        │    │ 标点符号风格     │    │ 最终评分        │
│ • 人格适配长度   │    │ • 问号使用      │    │ 范围: [0,1]     │
│ 权重: 0.15     │    │ • 结构化标点     │    │ 越高越匹配      │
│                │    │ 权重: 0.1       │    │               │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 3. 并发生成控制器 (PersonalityController)

```
用户输入 + 人格配置
        ↓
系统提示词构建 (build_system_prompt)
        ↓
并发候选生成 (ThreadPoolExecutor)
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
│候选1    │ │候选2    │ │候选3    │ │候选N    │
│temp=0.7 │ │temp=0.8 │ │temp=0.9 │ │temp=X   │
└─────────┘ └─────────┘ └─────────┘ └─────────┘
        ↓
风格评分与重排 (rerank_candidates)
        ↓
返回最佳匹配回答
```

## 📁 文件结构与职责

```
MBTI-LLM/
├── 核心引擎
│   ├── personality_rules.py      # 人格-行为映射规则库
│   ├── style_scorer.py          # 风格评分器
│   ├── personality_controller.py # 并发生成控制器
│   └── personality_templates.py  # 详细人格模板
│
├── 接口层
│   ├── main.py                  # 交互式主程序
│   ├── demo.py                  # 完整演示程序
│   └── run_example.py           # 对比示例
│
├── 测试验证
│   ├── test_integration.py      # 集成测试
│   ├── quick_test.py           # 快速模型测试
│   ├── simple_test.py          # 并发性能测试
│   └── high_performance.py     # 高性能压力测试
│
├── 配置部署
│   ├── setup.py               # 环境设置向导
│   ├── requirements.txt       # 依赖清单
│   └── README.md             # 完整文档
│
└── 架构文档
    └── ARCHITECTURE.md        # 本文件
```

## ⚡ 性能优化架构

### 并发处理流程

```
单线程串行 (旧版)                  多线程并发 (新版)
     ↓                              ↓
┌─────────┐                    ┌─────────────────┐
│ 请求1   │ → 等待 → 完成       │ ThreadPool      │
│ 请求2   │ → 等待 → 完成   →  │ ┌─────┐ ┌─────┐ │
│ 请求3   │ → 等待 → 完成       │ │请求1│ │请求2│ │
│ ...     │                    │ └─────┘ └─────┘ │
└─────────┘                    │ ┌─────┐ ┌─────┐ │
总时间: N * T                   │ │请求3│ │...  │ │
                               │ └─────┘ └─────┘ │
                               └─────────────────┘
                               总时间: T (理想情况)
```

### GPU利用率优化

```
问题: 20B模型 → 显存占满 → 无并发空间
                     ↓
解决: 7B模型 → 显存充足 → 支持并发
                     ↓
效果: CPU等待减少 → GPU利用率提升
```

## 🎯 人格化映射机制

### MBTI维度量化

```
    E ←──────────── 0 ──────────→ I
   外向              中性             内向
   
    S ←──────────── 0 ──────────→ N  
   感觉              中性             直觉
   
    T ←──────────── 0 ──────────→ F
   思考              中性             情感
   
    J ←──────────── 0 ──────────→ P
   判断              中性             感知
```

### 可观测行为转换

```
MBTI抽象特质 → 具体语言行为 → 可计算指标

ENTJ (高E+T+J):
• 领导力 → 直接号召句 → direct_calls=0.8
• 效率  → 短段落结构 → short_paragraphs=true  
• 逻辑  → 前提-结论 → logical_structure=0.9

INFP (低E+F+P):
• 共情  → 理解用语 → empathy_phrases=0.8
• 内向  → 限定词汇 → hedging_words=0.4
• 开放  → 问题结尾 → open_questions=0.7
```

## 🔄 状态机设计

### 情绪状态转换

```
               愉悦度高 (Valence > 0)
                       ↑
   唤醒度低 ←────── [平静满足] ──────→ 唤醒度高
(Arousal < 0)        ↓              (Arousal > 0)
                [沮丧疲惫]            [兴奋热情]
                       ↓
               愉悦度低 (Valence < 0)

状态影响输出:
• 兴奋热情 → 更多感叹号、积极词汇
• 平静满足 → 温和语调、稳定结构  
• 沮丧疲惫 → 简洁表达、客观分析
• 焦虑愤怒 → 直接表达、强调紧迫性
```

## 📈 评估与监控

### 质量指标体系

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ 人格一致性       │    │ 生成质量        │    │ 性能指标        │
│ • 匹配度分数     │    │ • 流畅性       │    │ • 响应时间      │
│ • 风格稳定性     │    │ • 逻辑性       │    │ • 并发效率      │
│ • 可分辨性       │    │ • 相关性       │    │ • GPU利用率     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                ↓
                    ┌─────────────────────────┐
                    │     综合评估报告          │
                    │ • 系统整体表现           │
                    │ • 优化建议              │
                    │ • 异常预警              │
                    └─────────────────────────┘
```

## 🚀 扩展架构

### 模块化设计

```
当前支持: ENTJ, INFP, ISTP
            ↓
扩展方向: 全16种MBTI类型
            ↓
进阶目标: Big Five连续化
            ↓
终极目标: 个性化人格定制

插件化架构:
┌─────────────────┐    ┌─────────────────┐
│ 人格模块接口     │    │ 评分器接口       │
│ • add_persona   │    │ • custom_scorer │
│ • load_rules    │    │ • train_model   │
└─────────────────┘    └─────────────────┘
            ↓                    ↓
┌─────────────────────────────────────────┐
│           核心引擎保持不变                │
└─────────────────────────────────────────┘
```

## 🔒 安全与伦理

### 安全边界设计

```
输入层安全 → 人格边界检查 → 输出过滤 → 用户提醒

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ 恶意输入检测     │    │ 人格误导防范     │    │ 敏感场景标注     │
│ • 注入攻击      │    │ • 避免刻板印象   │    │ • 医疗免责声明   │
│ • 诱导越狱      │    │ • 防止偏见放大   │    │ • 法律风险提示   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

---

**架构设计原则:**
- 🎯 **可观测性**: 抽象人格特质转化为可计算的语言行为
- ⚡ **高性能**: 并发生成与智能重排保证效率与质量  
- 🔧 **可扩展**: 模块化设计支持新人格类型和评分算法
- 🛡️ **安全性**: 多层边界检查防范滥用与误导
- 📊 **可监控**: 全面指标体系支持持续优化