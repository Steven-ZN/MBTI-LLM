好的，我帮你把这些 ASCII 图表改成 **Markdown 表格排版**，避免在不同平台渲染时错乱。下面是整理后的版本：

---

# MBTI-LLM 系统架构设计

## 整体架构图

| 层级            | 模块                     | 说明                 |
| ------------- | ---------------------- | ------------------ |
| **L3 记忆与安全层** | 人设记忆                   | 对话历史一致性            |
|               | 安全边界                   | 避免误导映射             |
|               | 漂移监测                   | 风格偏离纠正             |
| **L2 控制器层**   | Persona Prompt Builder | 构建人格提示             |
|               | 候选生成器 (并发)             | 多路候选输出             |
|               | 风格重排器 (评分筛选)           | 匹配度选择最佳            |
| **L1 人格状态层**  | MBTI 向量                | E/I, S/N, T/F, J/P |
|               | 情绪状态机                  | Valence, Arousal   |
|               | 行为规则库                  | 语言风格、结构模板          |
| **L0 基座模型层**  | Ollama 服务              | 本地模型接口             |
|               | deepseek-llm:7b        | 推理引擎               |
|               | API 调用                 | 外部接口调用             |

---

## 数据流处理图

| 流程     | 输入    | 输出              |
| ------ | ----- | --------------- |
| Step 1 | 用户问题  | `"如何..."`       |
| Step 2 | 人格类型  | 如 ENTJ          |
| Step 3 | 提示词构建 | 系统角色 + 规则       |
| Step 4 | 候选生成  | ThreadPool 并发候选 |
| Step 5 | 风格评分  | 匹配度计算           |
| Step 6 | 重排选择  | Top-1 输出        |
| Step 7 | 最佳回答  | 回答 + 评分         |

---

##  核心组件架构

### 1. 人格规则映射器 (PersonalityRules)

| 属性       | 示例值  | 说明          |
| -------- | ---- | ----------- |
| mbti     | ENTJ | 人格类型        |
| e\_score | 0.8  | 外向性 \[-1,1] |
| s\_score | 0.2  | 感觉性 \[-1,1] |
| t\_score | 0.9  | 思考性 \[-1,1] |
| j\_score | 0.9  | 判断性 \[-1,1] |
| valence  | 0.2  | 情绪愉悦度       |
| arousal  | 0.7  | 情绪唤醒度       |

映射规则：

| 类别 | 规则                                                                | 示例   |
| -- | ----------------------------------------------------------------- | ---- |
| 句式 | direct\_calls=0.8, short\_paragraphs=true, logical\_structure=0.9 | 行动导向 |
| 词汇 | power\_words=\["战略","执行","效率"]                                    | 偏好用词 |
| 词汇 | avoid\_words=\["可能","也许"]                                         | 避免用词 |
| 结构 | opening="结论先行", closing="行动建议"                                    | 结构模板 |

---

### 2. 风格评分器 (StyleScorer)

| 模块       | 指标              | 权重   |
| -------- | --------------- | ---- |
| 句子结构分析   | 平均句长、直接号召句      | 0.3  |
| 词汇匹配度    | 偏好词使用、限定词频率     | 0.25 |
| 语调一致性    | 感叹号比例、限定词使用     | 0.2  |
| 长度风格     | 人格适配长度          | 0.15 |
| 标点符号风格   | 问号使用、结构化标点      | 0.1  |
| **最终评分** | 范围 \[0,1]，越高越匹配 | -    |

---

### 3. 并发生成控制器 (PersonalityController)

| 步骤          | 说明                        |
| ----------- | ------------------------- |
| 用户输入 + 人格配置 | 进入系统                      |
| 系统提示词构建     | build\_system\_prompt     |
| 并发候选生成      | ThreadPoolExecutor (不同温度) |
| 风格评分与重排     | rerank\_candidates        |
| 返回最佳结果      | 输出匹配度最高的回答                |

---
